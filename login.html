<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecom-Deals - Login</title>
    <link rel="icon" type="image/x-icon" href="logo.png">
    <link rel="stylesheet" href="style.css">

    <!-- Your site scripts -->
    <script src="script.js" defer></script>
    <script src="header.js" defer></script>
    <script src="footer.js" defer></script>

    <!-- Google Adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1576490438435442" crossorigin="anonymous"></script>
</head>

<body>

<main class="login">
    <h1 style="text-align:center;">Login</h1>
    <form id="login-form">
        <input type="text" id="username" placeholder="Username" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit">Login</button>
    </form>

    <div style="text-align:center; margin-top:20px;">
        <!-- Amazon Login Button -->
        <a href="#" id="LoginWithAmazon">
            <img border="0" alt="Login with Amazon"
                 src="https://images-na.ssl-images-amazon.com/images/G/01/lwa/btnLWA_gold_156x32.png"
                 width="156" height="32" />
        </a>
    </div>
</main>

<!-- Amazon SDK Root -->
<div id="amazon-root"></div>

<!-- Amazon SDK Loader and Setup -->
<script type="text/javascript">
    window.onAmazonLoginReady = function() {
        amazon.Login.setClientId('amzn1.application-oa2-client.b4f87693d14b4c82a628824194ba48de'); // Replace with your real Client ID
    };

    (function(d) {
        var a = d.createElement('script'); 
        a.type = 'text/javascript';
        a.async = true;
        a.id = 'amazon-login-sdk';
        a.src = 'https://assets.loginwithamazon.com/sdk/na/login1.js';
        d.getElementById('amazon-root').appendChild(a);
    })(document);
</script>

<!-- Amazon Login Button Action -->
<script type="text/javascript">
    document.getElementById('LoginWithAmazon').onclick = function() {
        var options = { scope: 'profile' };

        // Save current page URL before starting Amazon login
        localStorage.setItem('redirectAfterLogin', window.location.href);

        amazon.Login.authorize(options, function(response) {
            if (response.error) {
                alert('OAuth error: ' + response.error);
                return;
            }
            console.log('Amazon Access Token:', response.access_token);

            // Save the access token temporarily
            localStorage.setItem('amazon_access_token', response.access_token);

            // Redirect to a special page to fetch profile
            var redirectUrl = localStorage.getItem('redirectAfterLogin') || '/';
            window.location.href = redirectUrl + '?access_token=' + response.access_token;
        });
        return false;
    };
</script>

<!-- Handle Access Token and Fetch Amazon Profile -->
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const accessToken = urlParams.get('access_token');

        if (accessToken) {
            fetch('https://api.amazon.com/user/profile', {
                headers: {
                    Authorization: 'Bearer ' + accessToken
                }
            })
            .then(response => response.json())
            .then(profile => {
                console.log('Amazon Profile:', profile);
                // Save user details into localStorage
                const user = {
                    name: profile.name,
                    email: profile.email
                };
                localStorage.setItem('user', JSON.stringify(user));

                // Clean URL (remove access_token from URL)
                window.history.replaceState({}, document.title, window.location.pathname);

                // Optionally, reload the page to update UI
                window.location.reload();
            })
            .catch(error => {
                console.error('Failed to fetch Amazon profile:', error);
            });
        }
    });
</script>

</body>
</html>
