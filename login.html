<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ecom-Deals - Login</title>
    <link rel="icon" type="image/x-icon" href="logo.png" />
    <link rel="stylesheet" href="style.css" />

    <!-- Your site scripts -->
    <script src="script.js" defer></script>
    <script src="header.js" defer></script>
    <script src="footer.js" defer></script>

    <!-- Google Adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1576490438435442" crossorigin="anonymous"></script>

    <!-- Google Platform Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
<main class="login">
    <h1 style="text-align:center;">Login</h1>
    <form id="login-form">
        <input type="text" id="username" placeholder="Username" required />
        <input type="password" id="password" placeholder="Password" required />
        <button type="submit">Login</button>
    </form>

    <div style="text-align:center; margin-top:20px;">
        <!-- Amazon Login Button -->
        <a href="#" id="LoginWithAmazon">
            <img
                border="0"
                alt="Login with Amazon"
                src="https://images-na.ssl-images-amazon.com/images/G/01/lwa/btnLWA_gold_156x32.png"
                width="156"
                height="32"
            />
        </a>
    </div>

    <div style="text-align:center; margin-top:20px;">
        <!-- Google Sign-In Button -->
        <div id="g_id_signin"></div>
    </div>
</main>

<!-- Amazon SDK Root -->
<div id="amazon-root"></div>

<script type="text/javascript">
    // Amazon Login setup
    window.onAmazonLoginReady = function () {
        amazon.Login.setClientId('amzn1.application-oa2-client.b4f87693d14b4c82a628824194ba48de'); // Your Amazon Client ID
    };

    (function (d) {
        var a = d.createElement('script');
        a.type = 'text/javascript';
        a.async = true;
        a.id = 'amazon-login-sdk';
        a.src = 'https://assets.loginwithamazon.com/sdk/na/login1.js';
        d.getElementById('amazon-root').appendChild(a);
    })(document);

    document.getElementById('LoginWithAmazon').onclick = function () {
        var options = { scope: 'profile' };
        localStorage.setItem('redirectAfterLogin', window.location.href);

        amazon.Login.authorize(options, function (response) {
            if (response.error) {
                alert('OAuth error: ' + response.error);
                return;
            }
            console.log('Amazon Access Token:', response.access_token);
            localStorage.setItem('amazon_access_token', response.access_token);
            var redirectUrl = localStorage.getItem('redirectAfterLogin') || '/';
            window.location.href = redirectUrl + '?access_token=' + response.access_token;
        });
        return false;
    };

    // On page load, handle Amazon access token in URL
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const accessToken = urlParams.get('access_token');

        if (accessToken) {
            fetch('https://api.amazon.com/user/profile', {
                headers: {
                    Authorization: 'Bearer ' + accessToken,
                },
            })
                .then((response) => response.json())
                .then((profile) => {
                    console.log('Amazon Profile:', profile);
                    const user = {
                        name: profile.name,
                        email: profile.email,
                    };
                    localStorage.setItem('user', JSON.stringify(user));
                    window.history.replaceState({}, document.title, window.location.pathname);
                    window.location.reload();
                })
                .catch((error) => {
                    console.error('Failed to fetch Amazon profile:', error);
                });
        }
    });

    // Google Login setup
    function handleCredentialResponse(response) {
        // response.credential is the ID token JWT
        console.log('Google ID Token:', response.credential);

        // You can decode the JWT or send it to your backend to verify and get user info
        // For demo, we decode payload to get profile info client side (not secure for prod)
        const base64Url = response.credential.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                })
                .join('')
        );
        const profile = JSON.parse(jsonPayload);
        console.log('Google Profile:', profile);

        const user = {
            name: profile.name,
            email: profile.email,
            picture: profile.picture,
        };
        localStorage.setItem('user', JSON.stringify(user));

        // Optionally, update UI or redirect
        alert('Logged in as ' + user.name);
    }

    window.onload = function () {
        google.accounts.id.initialize({
            client_id: '1071786232789-bu287pl66hm86fo72sjbfljvjs73c7ca.apps.googleusercontent.com',
            callback: handleCredentialResponse,
        });
        google.accounts.id.renderButton(document.getElementById('g_id_signin'), {
            theme: 'outline',
            size: 'large',
        });
        // Optional: prompt the user to sign in automatically
        // google.accounts.id.prompt();
    };
</script>
</body>
</html>
