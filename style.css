document.addEventListener('DOMContentLoaded', () => {
    const storedUser = JSON.parse(localStorage.getItem('user'));

    // Create the header element
    const header = document.createElement('header');
    header.className = 'navbar';

    // Left side of the navbar (logo + menu toggle)
    const left = document.createElement('div');
    left.className = 'navbar-left';

    const menuToggle = document.createElement('div');
    menuToggle.className = 'menu-toggle';
    for (let i = 0; i < 3; i++) {
        const bar = document.createElement('div');
        bar.className = 'bar';
        menuToggle.appendChild(bar);
    }

    const logo = document.createElement('div');
    logo.className = 'logo';
    logo.textContent = 'EcomDeals';

    left.appendChild(menuToggle);
    left.appendChild(logo);

    // Right side of the navbar (user/login state)
    const right = document.createElement('div');
    right.className = 'navbar-right';

    const nav = document.createElement('nav');
    nav.className = 'main-nav';

    if (storedUser) {
        // If logged in, show the user's name and logout button
        const userName = document.createElement('span');
        userName.className = 'user-name';
        userName.textContent = `Hi, ${storedUser.name.split(' ')[0]}`;

        const logoutButton = document.createElement('button');
        logoutButton.className = 'logout-button';
        logoutButton.textContent = 'Logout';
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('user');
            window.location.reload(); // Reload to update header
        });

        nav.appendChild(userName);
        nav.appendChild(logoutButton);
    } else {
        // If not logged in, show Login link
        const loginLink = document.createElement('a');
        loginLink.href = 'login.html'; 
        loginLink.textContent = 'Login';
        
        // Save redirect URL before going to login page
        loginLink.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default <a> click
            localStorage.setItem('redirectAfterLogin', window.location.href); // Save current page
            window.location.href = 'login.html'; // Redirect manually
        });

        nav.appendChild(loginLink);
    }

    right.appendChild(nav);
    
    // Add left and right sides to the header
    header.appendChild(left);
    header.appendChild(right);

    // Mobile menu toggle functionality
    menuToggle.addEventListener('click', () => {
        nav.classList.toggle('nav-open');
        menuToggle.classList.toggle('toggle-open');
    });

    // Insert header into the document
    document.body.insertBefore(header, document.body.firstChild);

    // --- Handle post-login redirect if needed ---
    if (window.location.pathname.endsWith('login.html')) {
        const user = JSON.parse(localStorage.getItem('user'));
        if (user) {
            const redirectUrl = localStorage.getItem('redirectAfterLogin') || '/';
            localStorage.removeItem('redirectAfterLogin');
            window.location.href = redirectUrl;
        }
    }
});
